<!doctype html>
<html>
  <head>
	<title>InTech Support hangout</title>
	<link rel="stylesheet" type="text/css" href="/stylesheets/style.css">
	<script src="http://fonzztonio.no-ip.biz:3000/socket.io/socket.io.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	
	<!--	
	<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/default.min.css">

	-->
	<script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/stylesheets/highlight.css">

	<script>
		
		$.getDocHeight = function(){
			return Math.max(
				$(document).height(),
				$(window).height(),
				/* For opera: */
				document.documentElement.clientHeight
			);
		};

		function resizeWindow(){
			var winHeight = $(window).height();
			var titleChatHeight = $("#title_chat").height();
			var messageHeight = $("#message").height();

			$("#title_chat").hide();
			$("#main").hide();
			$("#message").hide();

			$("#title_chat").height(0.10*winHeight);
			$("#main").height(0.78*winHeight);
			$("#message").height(0.04*winHeight);

			$("#title_chat").show();
			$("#main").show();
			$("#message").show();

		}

		$(window).resize(function() {
  			//resize just happened, pixels changed
			resizeWindow();
		});	
	</script>
  </head>
  <body>
  	<div id="title_chat">
		<div id="ban">
			<img src="/images/logo.gif" alt="Accueil">
		</div>
		<div id="title_text">
			<h1>Support hangout - Powered by Node.JS</h1>
		</div>
	</div>
	<!-- Section page-->
	<div id="main">
		<div id="chat">

		</div>
		<div id="users">
			<div id="users_title">
				<span style="text-decoration: underline; text-align: center">Server info</span><br/><br/>
				<img class="init" id="img_server_status_dis" src="/images/red_min.png" alt="">
				<img class="init" id="img_server_status_con" src="/images/green_min.png" alt="">
				<img class="init" id="img_server_status_err" src="/images/red_red_min.png" alt="">
				<span class="init_sp" id="server_status"></span>
				<span class="init_sp" id="nb_users"></span>
				<img class="init" id="img_bu" src="/images/business_users_min.png" alt="users">

			</div>
			
			<ul id="list_users">	
			</ul>
		</div>
	</div>
	<br/>
	<div id="message">
		<div id="input_m">
			<textarea id="m" rows="2" autocomplete="off"></textarea>
		</div>
		<div id="input_submit">
			<button id="submit_button">Send</button>
			<button id="code_button">Code</button>
			<br/>
			<img id="img_padlock" src="/images/padlock_open.png" alt="padlock" title="Lock/unlock chat scroll" >
		</div>
	</div>
	
	<!-- Section Socket IO -->


	<script>
		var inactive = false;
		var nbMsg = 0;
		var lock_div = 0;
		resizeWindow();	

		// On demande le pseudo au visiteur...
		var pseudo = prompt('Quel est votre pseudo ?');
		while(pseudo === 'undefined' || pseudo === 'null' || pseudo.length > 25 || pseudo.length == 0){
			var pseudo = prompt('Quel est votre pseudo ?\n !!! 25 caractÃ¨res maximum !!! Champ vide, null et undefined sont interdits');
		}

		var socket = io.connect('http://fonzztonio.no-ip.biz:3000', {
			'reconnect': true,
			'reconnection delay': 500,
			'sync disconnect on unload': false
		});


		// Et on l'envoie avec le signal "new_user" (pour le diff de "message"
		socket.emit('new_user', pseudo);
				
		// Initialisation du highliter de code
		hljs.initHighlightingOnLoad();
		

		/*###################
		 ### Partie envoi ###
		 ####################*/

		// envoi d'un message

		$("#submit_button").click(function(){
			var msg = $('#m').val();
			if(msg.length > 0){
				socket.emit('chat_message', pseudo, msg);
			}
			$('#m').val('');
			return false;
		});
	
		$("#m").keyup(function (e) {
			if (e.keyCode == 13) {
				var msg = $('#m').val()
				msg = msg.substring(0, msg.length - 1);
				if(msg.length > 0){
					socket.emit('chat_message', pseudo, msg);
				}
				$('#m').val('');
				return false;		
			}
		});

		// Envoi de code
		$("#code_button").click(function(){
			var code = $('#m').val();
			if(code.length > 0){
				socket.emit('code_message', pseudo, code);
			}
			$('#m').val('');
			return false;
		});

		$(window).bind("beforeunload", function() { 	
			socket.emit('user_disconnect');
		});

		/*#######################
		 ### Partie reception ###
		#########################*/

		// Reception de la liste des utilisateirs
		socket.on('list_users', function(data){
			reloadUsersList(data);
		});

		function reloadUsersList(data){	
			$('#img_bu').show();	
			$("#nb_users").empty();
			$("#nb_users").append(data.length+" members");
			$('#list_users').empty();
			var users = $.parseJSON(JSON.stringify(data));
			$.each(users, function(i, item) {
				var li = $("<li>");
				$('#list_users').append($('<li>').html(item.pseudo));
			});

		}

		// Reception d'un message
		socket.on('chat_message', function(pseudo, msg){
			// Build HTML to insert
			var user_img = $('<img class=\"pic_user\" src=\"/images/user_icon_16.gif\" alt=\"user\">');
			var user_pseudo = $('<div class=\"pseudos\">');
			var user_message = $('<div class=\"messages\">');
			var chat_table = $('<div class=\"chat_table\">');
			
			$(user_pseudo).append($(user_img));
			$(user_pseudo).append(pseudo+' : ');
			$(chat_table).append($(user_pseudo));
			$(chat_table).append($(user_message).text(msg));
			$('#chat').append($(chat_table));	

			autoScroll();

			if(inactive == true){
				notifyUser();
			}
		});


		// Reception de code  
		socket.on('code_message', function(pseudo, code){
			// Text formating
			code = code.replace(/ /g, '&nbsp;');
			code = code.replace(/(?:\r\n|\r|\n)/g, '<br />');
		
			// Build HTML to insert
			var user_img = $('<img class=\"pic_user\" src=\"/images/user_icon_16.gif\" alt=\"user\">');
			var user_pseudo = $('<div class=\"pseudos\">');
			var user_message = $('<div class=\"code_langage code_messages\">');
			var chat_table = $('<div class=\"chat_table\">');
			
			$(user_pseudo).append($(user_img));
			$(user_pseudo).append(pseudo+' : ');
			$(chat_table).append($(user_pseudo));
			$(chat_table).append($(user_message).html(code));
			$('#chat').append($(chat_table));	

			$('.code_langage').each(function(i, block) {
				 hljs.highlightBlock(block);
			});

			autoScroll();

			if(inactive == true){
				notifyUser();
			}

		});

		// Message serveur
		socket.on('host_message', function(pseudo, code){
			var server_img = $('<img class=\"pic_user\" src=\"/images/server_icon_16.gif\" alt=\"server\">');
			var user_pseudo = $('<div class=\"pseudos\">');
			var user_message = $('<div class=\"messages\">');
			var chat_table = $('<div class=\"chat_table server_message\">');
			
			$(user_pseudo).append($(server_img));
			$(user_pseudo).append(pseudo+' : ');
			$(chat_table).append($(user_pseudo));
			$(chat_table).append($(user_message).text(msg));
			$('#chat').append($(chat_table));	

			autoScroll();

			if(inactive == true){
				notifyUser();
			}
			console.log('server msg');

		});

		/*######################
		###  SERVER STATUS   ###
		######################*/
	
		socket.on('connect_failed', function(){
			$('#server_status').empty();
			$('#server_status').append("Failed to connect | ");
			$('#img_server_status_dis').hide();
			$('#img_server_status_con').hide();
			$('#img_server_status_err').show();
		});

		socket.on('connect', function () {
			$('#server_status').empty();
			$('#server_status').append("Connected | ");
			$('#img_server_status_dis').hide();
			$('#img_server_status_err').hide();
			$('#img_server_status_con').show();

		});

		socket.on('disconnect', function () {
			$('#server_status').empty();
			$('#server_status').append("Disconnected | ");
			$('#img_server_status_con').hide();
			$('#img_server_status_con').hide();
			$('#img_server_status_dis').show();
		});

		/*######################
		### DESIGN an BEHAVE ###
		######################*/
		// handle notification on title
		$(window).on("blur", function(){
			inactive = true;
		});

		$(window).on("focus", function(){
			document.title = "InTech Support Hangout";
			inactive = false;
			nbMsg = 0;
		});

		function notifyUser(){
			nbMsg = nbMsg+1;
			document.title = "("+nbMsg+") - InTech Support Hangout";
		}

		// AutoScroll 
		function autoScroll(){
			if(lock_div == 0){
				$("#chat").scrollTop($("#chat")[0].scrollHeight);
			}
		}

		$("#img_padlock").click(function(){
			if(lock_div == 0){
				lock_div = 1;
				$("#img_padlock").attr("src", "/images/padlock_close.png");
			}else{
				lock_div = 0;
				$("#img_padlock").attr("src", "/images/padlock_open.png");
			}	
		});

		
	</script>
  </body>
</html>
